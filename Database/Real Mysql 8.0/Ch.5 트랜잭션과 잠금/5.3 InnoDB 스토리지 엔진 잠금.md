# 5.3 InnoDB 스토리지 엔진 잠금
> InnoDB는 스토리지 엔진 내부에서 `레코드 기반 락`을 지원한다.

즉 테이블 단위로 락을 걸지 않기 떄문에 동시성 성능이 좋아졌다. (MyISAM에 비해)

InnoDB는 다음의 락을 가진다.
1. 레코드 락
2. 갭 락
3. 넥스트 키 락 : 갭락 + 레코드 락

<br>
<br>

---
### 레코드 락
> 하나의 레코드를 잠그는 것으로, 실제로는 인덱스의 레코드를 잠근다.

- 업데이트 문에 세컨더리 인덱스를 통한 조건절이 있다면 넥스트 키락 이 걸린다.
- PK, 유니크 인덱스 컬럼에 대한 조건이 동등조건으로 있다면 레코드에만 락을 건다

```
세컨더리 인덱스이 경우에, 고유한 레코드를 보장하지 않기 때문에 동등조건이라도 넥스트 키 락을 사용한다.
(다른 트랜잭션이 같은 값을 가진 레코드를 삽입하는 것을 막기 위해서 - 팬텀 리드 방지)

반면 PK 나 유니크 컬럼에 대해 동등조건절을 통해 업데이트 문을 실행하면, 하나의 레코드만 잠근다.
```

<br>
<br>

---
### 갭 락
> 레코드가 아니라 레코드와 레코드 사이를 잠근다.

레코드 사이 간격에 새 레코드가 삽입되면 팬텀리드가 발생할 수 있으므로 잠금


<br>
<br>

---
### 넥스트 키 락
> 레코드 락 + 갭 락 = 즉 현재 레코드와 그 사이의 간격에 대해 락을 건다.

- 격리수준 `Repeatable Read` 에서 기본 동작한다.
- 팬텀 리드를 막기 위함이다.
  새로운 데이터 삽입으로 인한 같은 트랜잭션 내 `select`의 비일관성을 해결할 수 잇다.


<br>
<br>

---
## 인덱스와 잠금

- InnoDB에서 레코드 락은 인덱스레 락을 건다.
- 더 정확히는 변경할 레코드를 찾기 위해 조건절 컬럼의 값으로 검색된 인덱스의 리프 노드의 레코드를 모두 잠근다.
```
성이 '홍'이고 이름이 '길동'인 사람의 이름을 '원빈'으로 수정하는 상황이라면
조건절이 where 성 = '홍' and 이름 = '길동'; 일 것이다.
이때 성 이라는 컬럼에 인덱스가 걸려 있다면, 해당 조건의 컬럼을 찾기 위해 인덱스 탐색 시 성이 '홍'인 리프 노드 레코드를 모두 조회 했을 텐데
이 레코드를 모두 잠근다는 것이다.

때문에 다른 트랜잭션이 홍이라는 성의 새로운 사람을 insert 하려 하면 갭 락이 걸려 해당 인서트는 대기해야 한다. -> 팬텀리드 방지
```
- 조건절이 위의 예시와 다르게 인덱스를 타지 않으면, InnoDB는 어떤 레코드가 수정 삽입될지 모르기 때문에 모든 레코드에 락 or 비 효율적인 레인지 락으로 동시성 성능이 떨어질 수 있다.
  (테이블 전체를 스캔하며 레코드를 조회하기 떄문에 넓은 범위에 락이 걸릴 수 있다.)
- 즉 인덱스를 적절히 설정해서 조건절에 활용 해야 한다.
