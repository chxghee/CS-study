# 5.2 Mysql 엔진의 잠금

- Mysql 엔진의 잠금은 스토리지 엔진에도 영향을 미치지만 스토리지 엔진의 잠금은 스토리지 엔진간에 상호 영향을 미치지 않는다.
Mysql 엔진의 잠금에는 다음의 세가지가 존재한다.

1. 테이블 락
2. 메타데이터 락
3. 네임드 락

<br>
<br>

---

## 글로벌 락
> 보통 일관된 백업 작업을 해야 할 떄 글로벌 락을 걸어 백업을 한다.

- 글로벌 락의 범위: SQL 서버 내 모든 DB, table에 대해 락이 걸린다.
- 락이 걸리면 select를 제외한 DML, DDL 을 실행할 수 없다.

```sql
FLUSH TABLES WITH READ LOCK
```
위와 같은 명령으로 글로벌 락을 걸 수 있다.

하지만 InnoDB에 경우, 트랜잭션을 지원하기 떄문에 글로벌 락을 걸어 모든 쓰기 작업을 멈추고 백업할 필요까지는 없다.  
-> 언두 로그를 통해 백업 요청 시점 스냅샷으로 백업 데이터를 저장할 수 있기 때문이다.(MVCC)  

즉 백업 도중 DML이 실행되고 커밋 되어도 백업 작업에는 영향이 없다는 얘기이다.

<br>

하지만 DDL과 같이 스키마와 사용자 인증정보를 수정하는 작업이 백업 작업을 방해하지 못하도록 락을 걸어야 한다.
- 글로벌 락을 거는 대신 `백업 락`을 걸어 백업을 진행한다.

[백업 락]
1. DB 테이블, View 등 모든 DB 객체 생성, 변경, 삭제가 불가
2. `REPAIR TABLE`, `OPTIMIZE TABLE`명령 불가
3. 사용자 관리 및 비번 변경 불가

백업락을 걸면 위와 같은 작업에 대해 잠금이 걸린다.



<br>
<br>

---
## 테이블 락
> 개별 테이블 단위로 락을 거는 것이다.

- MyISAM에서는 테이블의 레코드를 변경하는 쿼리를 실행하면 SQL 서버가 묵시적으로 테이블락을 발생시킨다.  
  (MyISAM은 레코드 기반 락 지원 x)

명시적으로 테이블에 대해 락을 걸고 싶으면 다음과 같은 쿼리를 실행하면 된다.
```sql
LOCK TABLES 테이블 명 [READ | WRITE]
```


<br>


- InnoDB 는 스토리지 엔진에서 레코드 기반 잠금을 지원해서 단순 DML 실행 시에는 테이블 락을 걸지 않는다.
- DDL 실행 시에는 테이블 락을 건다.




<br>
<br>

---
## 네임드 락
> 사용자가 지정한 문자열을 **이름(Name)**으로 가지는 사용자 정의 잠금

다음의 쿼리로 실행 가능하다.
```sql
SELECT GET LOCK ('문자열', 잠금 시간(초))
```

- 동작 원리: 지정한 이름의 락을 하나의 세션만 가질 수 있다 → 서로 다른 세션끼리 직렬화된 순서로 작업 가능
- 목적: 일반적인 레코드/테이블 락이 아닌, `비즈니스 로직 단위`의 상위 잠금을 구현할 때 사용한다.

[다량 업데이트 시 네임드 락 효과]
- 예) 다량의 레코드를 업데이트하는 트랜잭션을 여러 세션이 동시에 실행하면, 인덱스 범위 락이나 넥스트 키 락 때문에 충돌 및 데드락이 발생할 수 있다.
- 이때 네임드 락으로 선점한 세션 하나만 업데이트를 수행하게 하면  
	  -	나머지 세션은 대기  
	  -	충돌 없이 순차적(직렬화) 처리 가능  
	  -	데드락 방지에 효과적이다.  
  



<br>
<br>

---
## 메타데이터 락
> DB 객체(테이블이나 뷰)의 이름이나 구조를 변경할 떄 자동으로 획득하는 락

다음과 같이 순위 테이블의 데이터를 rank_backup 으로 바꾸고 새로 저장할 순위 테이블(rank_new)을 rank으로 바꾸는 쿼리이다.
```sql
rename table rank to rank_backup, rank_new to rank
```
