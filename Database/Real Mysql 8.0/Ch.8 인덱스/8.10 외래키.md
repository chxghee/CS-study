# 8.10 외래키
외래키 제약 설정 시 자동으로 자식 테이블(외래키를 가진 테이블)의 칼럼에 인덱스가 생성된다.


외래키 관리에는 두가지 특징이 있다/.

-  특징 1. 테이블의 변경(쓰기 잠금)이 발생하는 경우에만 잠금대기가 발생한다.

-  특징 2. 외래키와 연관되지 않은 컬럼의 변경은 최대한 잠금 대기를 발생시키지 않는다.


그렇다면 잠금 대기가 발생하는 경우에는 어떤 상황이 있는지 알아보자

### 자식 테이블의 변경이 대기하는 경우

| 작업 번호 | 커넥션-1                                | 커넥션-2                                 |
|-----------|-----------------------------------------|------------------------------------------|
| 1         | BEGIN;                                  |                                          |
| 2         | UPDATE tb_parent                        |                                          |
|           | SET fd='changed-2' WHERE id=2;          |                                          |
| 3         |                                         | BEGIN;                                   |
| 4         |                                         | UPDATE tb_child                          |
|           |                                         | SET pid=2 WHERE id=100;                  |
| 5         | ROLLBACK;                               |                                          |
| 6         |                                         | Query OK, 1 row affected (3.04 sec)      |


- 먼저 부모 테이블에서 `id=2`인 레코드를 수정 중이다.
- 그 다음 자식 테이블에서 `pid=2`인 부모 레코드를 참조하도록 변경하는 쿼리를 실행했다.
- 하지만 `id=2`인 레코드는 부모가 수정 중이므로 잠금 대기를 하고
- 5번의 롤백이 일어나서야 자식 테이블의 쿼리가 실행된다.

### 부모 테이블의 변경이 대기하는 경우

| 작업 번호 | 커넥션-1                                 | 커넥션-2                                  |
|-----------|------------------------------------------|-------------------------------------------|
| 1         | BEGIN;                                   |                                           |
| 2         | UPDATE tb_child                          |                                           |
|           | SET fd='changed-100'                     |                                           |
|           | WHERE id=100;                            |                                           |
| 3         |                                          | BEGIN;                                    |
| 4         |                                          | DELETE FROM tb_parent                     |
|           |                                          | WHERE id=1;                               |
| 5         | ROLLBACK;                                |                                           |
| 6         |                                          | Query OK, 1 row affected (6.09 sec)       |

- `pid=1`을 참조하는 자식이 자신의 레코드를 수정하면 tb_child 테이블 레코드에 대해 잠금을 획득한다.
- 이때 부모 테이블에서 `id=1`인 레코드를 삭제하려 한다면, 자식의 쓰기 잠금이 해제될 떄 까지 대기해야 한다.  
  (정의된 외래키의 CASADE 특성 때문에 부모 삭제시 자식 레코드가 삭제될 수 있기 떄문이다.)

이렇듯 외래키는 테이블간 잠금의 전파가 일어나므로, 신중히 외래키를 모델링 해야 한다.

```
cf) 외래키 잠금의 종류
1. 읽기 잠금: 자식 튜플 생성시 부모 테이블 튜플이 존재하는지 체크하기 위해 유니크 인덱스 처럼 읽기 잠금이 일어남
2. 쓰기 잠금: 위에서 살펴 보았던 쓰기 잠금의 전파  
```
