# 9.1 옵티마이저 개요

> 옵티마이저는 쿼리의 최적 실행을 위해 각 테이블의 데이터가 어떻게 저장되어 있는지 통계정보를 통헤 실행계획을 세운다.

옵티마이저가 세운 쿼리의 실행 계획을 확인하기 위해서는 `EXPLAIN` 을 사용한다.

<br>

## 쿼리 실행 절차

SQL 엔진이 담당하는 쿼리 실행 절차는 다음과 같다

1. `SQL 파서`: 요청 sql 문을 잘게 쪼개서 서버가 이해할 수 있는 수준으로 분리한다.  
   ➡️ 토큰으로 분리된 쿼리문은 `파스 트리`에 트리 구조로 저장된다.  
   ➡️ 이러한 파싱 단계에서 쿼리문의 문법오류를 걸러낸다.

2. `옵티마이저`: 파싱정보(파스트리)를 확인하여 어떤 테이블에서 무슨 인덱스를 사용해서 데이터를 읽을 지 실행 계획을 세운다  
   ➡️ 불필요 조건 제거, 연산 단순화  
   ➡️ 여러 테이블 조인 시 어떤 순서로 테이블을 읽을지 결정  
   ➡️ where 조건절과 인덱스 통계 정보로 사용할 인덱스 결정  
   ➡️ 가져온 레코드를 임시 테이블에 넣고 다시한번 가공해야 하는지 결정        

3. 2단계에서 결정된 테이블 읽기 순서나 선택된 인덱스를 이용해 스토리지 엔진으로 부터 데이터를 가져온다.
   ➡️ SQL 엔진은 스토리지 엔진이 읽어온 레코드의 조인 or 정렬 or 연산 을 진행한다.



<br>   

### 옵티마이저의 종류
> 옵티마이저는 DB 서버의 두뇌 역할을 한다.

옵티마이저가 동작하는 방법에는 크게 두가지 종류가 있다.

### 1. 규칙 기반 최적화 방법 (RBO)
- 이전에 많이 사용되었던 방법
- 대상 테이블의 레코드 건수, 선택도 고려 x -> 옵티마이저에 내장된 우선순위(규칙)에 따라 실행 계획을 수립한다.
- 규칙기반으로 행동하기에 같은 쿼리에 대해 같은 실행 계획이 세워진다.


### 2. 비용 기반 최적화 방법 (CBO)
- 현재 대부분의 DBMS 가 사용하는 방법
- 쿼리 처리위한 여러 가능한 계획을 만들고
- 각 작업의 비용과 대상 테이블의 `예측된 통계 정보`를 이용해 실행 계획별 비용을 산출해 가장 최소 비용의 계획으로 쿼리를 실행한다.


이떄 통계 정보는 쿼리 실행 전에 옵티마이저가 데이터 분포를 예측하기 위해 사용하는 요약된 메타정보이며,
테이블 크기, 인덱스 상태, 값 분포(히스토그램), 카디널리티(컬럼고유한 값 수) 등을 확인할 수 있따.
